# V3 Configuration - Optimal Balance for Sample Diversity
#
# PHILOSOPHY: Combine V1's proven loss weights + V2's technical fixes
#
# KEY IMPROVEMENTS FROM V2:
#   1. beta_kl: 0.0005 → 0.01 (20x increase) - FIXES MODE COLLAPSE & DIVERSITY
#   2. lambda_grad: 2.0 → 0.0 (removed) - Prevents pixel-perfect copying
#   3. Restore V1 loss weights (w_min, w_max, tail_boost, lambda_mass)
#   4. Keep V2 fixes: pixel_threshold=1.0, denormalization
#
# EXPECTED RESULTS:
#   - Spatial correlation: 0.5-0.6 (healthy variation, not copying)
#   - Diversity: >0.15 (samples actually vary!)
#   - Mass conservation: ±10-15%
#   - KS test p-value: >0.05 (distributions match)
#   - Better SRDRN test generalization than V2

# Data paths
data_root: "/scratch/user/u.hn319322/ondemand/Downscaling/cVAE_augmentation"
outputs_root: "/scratch/user/u.hn319322/ondemand/Downscaling/cVAE_augmentation/outputs/cvae_v3"

# Static maps configuration
statics:
  use_land_sea: true
  use_dist_coast: true
  use_elevation: false
  normalize_statics: true

# Model architecture
model:
  d_x: 64
  in_channels_X: 6
  d_y: 256
  in_channels_Y: 1
  static_channels: 2
  d_z: 128              # Keep 128 for better latent capacity
  H: 156
  W: 132
  base_filters: 64

# Loss function - V3 OPTIMIZED
loss:
  type: "simplified"  # Use SimplifiedCVAELoss

  # Intensity weighting - Back to V1's successful values
  # P90 = 11.7 mm/day, P95 = 20.1 mm/day, P99 = 43.6 mm/day
  scale: 20.0         # Based on P95 percentile
  w_min: 0.1          # Back to V1 (was 0.5 in V2) - Better dynamic range
  w_max: 3.0          # Back to V1 (was 4.0 in V2) - Less overfitting

  # Extra boost for extreme tail (P99+)
  tail_boost: 2.0     # Back to V1 (was 1.5 in V2) - Stronger extreme emphasis

  # Mass conservation
  lambda_mass: 0.005  # Back to V1 (was 0.01 in V2) - More flexibility

  # Gradient (edge) loss - REMOVED in V3
  lambda_grad: 0.0    # Set to 0 (was 2.0 in V2) - Prevents pixel-perfect copying
                      # Note: Gradient loss likely contributed to mode collapse
                      # Background noise already fixed by denormalization + thresholding

  # KL divergence - CRITICAL FIX FOR DIVERSITY
  beta_kl: 0.01       # Back to V1 (was 0.0005 in V2) - 20x INCREASE
                      # This is THE PRIMARY FIX for mode collapse
                      # Low beta_kl → model ignores latent space → all samples identical
  warmup_epochs: 20

  p99_threshold: "from_thresholds_json"  # Will load P99=4.26

# Training configuration
train:
  epochs: 200
  batch_size: 64
  num_workers: 2
  lr: 0.0003
  weight_decay: 0.0005
  grad_clip: 1.0
  amp: true
  save_every: 20

  # Early stopping
  early_stopping_patience: 50
  early_stopping_metric: "MAE_tail"  # Optimize for extremes
  early_stopping_min_delta: 0.01

  # LR warmup
  lr_warmup_epochs: 5

  # Stratified sampling - See more heavy events
  use_stratified_sampling: true
  min_heavy_fraction: 0.4  # 40% heavy days per batch

# Learning rate scheduler
scheduler:
  type: "plateau"
  mode: "min"
  factor: 0.5
  patience: 20
  min_lr: 1.0e-6
  threshold: 0.01

# Validation
validation:
  val_every: 1
  log_every: 50

# Sampling - Keep V2's successful threshold
sampling:
  mode: "posterior"
  K: 5              # Generate 5 samples per heavy day
  days: "heavy_only"
  min_threshold: 0.1
  temperature: 1.0
  pixel_threshold: 1.0  # Keep V2 fix: 1.0 mm/day standard threshold (no NaN)

# Device
device: "cuda"
seed: 42
